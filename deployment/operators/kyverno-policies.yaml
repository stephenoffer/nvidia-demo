# Kyverno Policies for CI/CD Validation
# Replaces custom deployment validation with Kyverno

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-pod-security-standards
spec:
  validationFailureAction: enforce
  rules:
  - name: check-pod-security
    match:
      resources:
        kinds:
        - Pod
        namespaces:
        - pipeline-production
    validate:
      message: "Pod must have security context"
      pattern:
        spec:
          securityContext:
            runAsNonRoot: true
            seccompProfile:
              type: "RuntimeDefault"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-resource-limits
spec:
  validationFailureAction: enforce
  rules:
  - name: check-resource-limits
    match:
      resources:
        kinds:
        - Pod
        namespaces:
        - pipeline-production
    validate:
      message: "Container must have resource limits"
      pattern:
        spec:
          containers:
          - name: "*"
            resources:
              limits:
                memory: "?*"
                cpu: "?*"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: block-privileged-containers
spec:
  validationFailureAction: enforce
  rules:
  - name: check-privileged
    match:
      resources:
        kinds:
        - Pod
    validate:
      message: "Privileged containers are not allowed"
      pattern:
        spec:
          containers:
          - name: "*"
            securityContext:
              privileged: false

